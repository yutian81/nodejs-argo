name: Build and Release Appwrite

on:
  push:
    branches: [ appwrite ]
    paths:
      - 'appwrite-au/**'
      - 'appwrite-de/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code (Appwrite åˆ†æ”¯)
      uses: actions/checkout@v4
      with:
        ref: appwrite

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Validate required directories
      run: |
        for dir in appwrite-au appwrite-de; do
          if [ ! -d "$dir" ]; then
            echo "âŒ ç›®å½• $dir ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°ç›®å½•: $dir"
        done

    - name: Display directory info
      run: |
        echo "ðŸ“‚ å½“å‰ç›®å½•ç»“æž„:"
        ls -la
        echo ""
        for dir in appwrite-au appwrite-de; do
          echo "ðŸ“ $dir å†…å®¹:"
          ls -la "$dir"
          echo ""
        done

    - name: Create deployment archives
      id: package
      run: |
        TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
        echo "å½“å‰UTCæ—¶é—´æˆ³: $TIMESTAMP"
        mkdir -p dist
        for dir in appwrite-au appwrite-de; do
          ARCHIVE_NAME="${dir}.${TIMESTAMP}.tar.gz"
          tar -czf "dist/${ARCHIVE_NAME}" "$dir"
          echo "âœ… å·²åˆ›å»ºåŽ‹ç¼©åŒ…: dist/${ARCHIVE_NAME}"
        done
        echo "archives=$(ls dist/*.tar.gz | tr '\n' ' ')" >> $GITHUB_OUTPUT

    - name: Verify archives
      run: |
        echo "ðŸ“¦ å·²ç”ŸæˆåŽ‹ç¼©åŒ…åˆ—è¡¨:"
        ls -lh dist/
        for file in dist/*.tar.gz; do
          echo "ðŸ” $file å†…å®¹:"
          tar -tzf "$file"
          echo ""
        done

    - name: Generate release notes
      id: release_notes
      run: |
        LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        COMMIT_DATE=$(git log -1 --pretty=format:"%cd" --date=format:"%Y-%m-%d %H:%M")
        SHORT_SHA=$(git rev-parse --short HEAD)

        cat > release_notes.md << EOF
        ## ðŸš€ Appwrite Functions éƒ¨ç½²åŒ…

        æœ¬æ¬¡æž„å»ºè‡ªåŠ¨æ‰“åŒ…ä»¥ä¸‹ç›®å½•ï¼š
        - appwrite-au
        - appwrite-de

        **æœ€è¿‘æäº¤ï¼š**
        - æäº¤ä¿¡æ¯: ${LATEST_COMMIT}
        - æäº¤ä½œè€…: ${COMMIT_AUTHOR}
        - æäº¤æ—¶é—´: ${COMMIT_DATE}
        - æäº¤ç‰ˆæœ¬: ${SHORT_SHA}

        ðŸ“¦ æ‰“åŒ…æ—¶é—´ (UTC): $(date -u +"%Y-%m-%d %H:%M:%S")

        ä¸Šä¼ ä»¥ä¸‹åŽ‹ç¼©åŒ…ä»¥éƒ¨ç½²è‡³ Appwriteï¼š
        $(ls dist/*.tar.gz | xargs -n1 -I {} echo "- {}")
        EOF

    - name: Create or Update Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "appwrite-functions-latest"
        name: "Appwrite Functions"
        body_path: release_notes.md
        files: dist/*.tar.gz
        draft: false
        prerelease: false
        make_latest: true
        overwrite_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release Summary
      run: |
        echo "ðŸŽ‰ è‡ªåŠ¨æž„å»ºä¸Žå‘å¸ƒå®Œæˆï¼"
        echo "ðŸ“¦ åŒ…æ–‡ä»¶:"
        ls -lh dist/
        echo "ðŸ·ï¸ å‘å¸ƒåç§°: Appwrite Functions"
        echo "ðŸ”— å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/appwrite-functions-latest"
