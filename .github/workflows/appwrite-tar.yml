name: Build and Release Appwrite

on:
  push:
    branches: [ appwrite ]
    paths:
      - 'appwrite-*'
      - 'appwrite-*/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code (Appwrite åˆ†æ”¯)
      uses: actions/checkout@v4
      with:
        ref: appwrite

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Validate there are appwrite-* directories
      run: |
        set -euo pipefail
        shopt -s nullglob
        matches=(appwrite-*/)
        if [ ${#matches[@]} -eq 0 ]; then
          echo "âŒ æœªå‘çŽ°ä»»ä½•ä»¥ appwrite- å¼€å¤´çš„ç›®å½•ï¼ˆé¡¶å±‚ï¼‰"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°ä»¥ä¸‹ç›®å½•ï¼š"
        for d in "${matches[@]}"; do
          echo " - ${d%/}"
        done

    - name: Display directory info
      run: |
        set -euo pipefail
        echo "ðŸ“‚ æ ¹ç›®å½•åˆ—è¡¨:"
        ls -la
        echo ""
        shopt -s nullglob
        for d in appwrite-*/; do
          dir="${d%/}"
          echo "ðŸ“ ${dir} å†…å®¹:"
          ls -la "$dir" || true
          echo ""
        done

    - name: Create deployment archives
      id: package
      run: |
        set -euo pipefail
        shopt -s nullglob
        TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
        echo "å½“å‰UTCæ—¶é—´æˆ³: $TIMESTAMP"
        mkdir -p dist
        created=()
        for d in appwrite-*/; do
          dir="${d%/}"
          ARCHIVE_NAME="${dir}.${TIMESTAMP}.tar.gz"
          tar -czf "dist/${ARCHIVE_NAME}" "$dir"
          echo "âœ… å·²åˆ›å»ºï¼š dist/${ARCHIVE_NAME}"
          created+=("dist/${ARCHIVE_NAME}")
        done
        if [ ${#created[@]} -eq 0 ]; then
          echo "âŒ æœªç”Ÿæˆä»»ä½•åŽ‹ç¼©åŒ…ï¼ˆå¯èƒ½æ²¡æœ‰åŒ¹é…ç›®å½•ï¼‰"
          exit 1
        fi
        # å°†åŽ‹ç¼©åŒ…åˆ—è¡¨è¾“å‡ºåˆ° GITHUB_OUTPUTï¼Œä¾›åŽç»­æ­¥éª¤å¼•ç”¨ï¼ˆå¯é€‰ï¼‰
        echo "archives=${created[*]}" >> $GITHUB_OUTPUT

    - name: Verify archives
      run: |
        set -euo pipefail
        echo "ðŸ“¦ dist/ ç›®å½•å†…å®¹ï¼š"
        ls -lh dist/ || true
        for f in dist/*.tar.gz; do
          echo "ðŸ” æŸ¥çœ‹ $f å†…å®¹:"
          tar -tzf "$f"
          echo ""
        done

    - name: Generate release notes
      id: release_notes
      run: |
        set -euo pipefail
        LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        COMMIT_DATE=$(git log -1 --pretty=format:"%cd" --date=format:"%Y-%m-%d %H:%M")
        SHORT_SHA=$(git rev-parse --short HEAD)

        cat > release_notes.md <<EOF
## ðŸš€ Appwrite Functions éƒ¨ç½²åŒ…

æœ¬æ¬¡æž„å»ºè‡ªåŠ¨æ‰“åŒ…äº†ä»“åº“ä¸­æ‰€æœ‰ä»¥ **appwrite-** å¼€å¤´çš„ç›®å½•ã€‚

**æœ€è¿‘æäº¤ï¼š**
- æäº¤ä¿¡æ¯: ${LATEST_COMMIT}
- æäº¤ä½œè€…: ${COMMIT_AUTHOR}
- æäº¤æ—¶é—´: ${COMMIT_DATE}
- æäº¤ç‰ˆæœ¬: ${SHORT_SHA}

ðŸ“¦ æ‰“åŒ…æ—¶é—´ (UTC): $(date -u +"%Y-%m-%d %H:%M:%S")

**ä¸Šä¼ çš„åŽ‹ç¼©åŒ…ï¼š**
$(for f in dist/*.tar.gz; do echo "- ${f}"; done)

EOF

    - name: Create or Update Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "appwrite-functions-latest"
        name: "Appwrite Functions"
        body_path: release_notes.md
        files: dist/*.tar.gz
        draft: false
        prerelease: false
        make_latest: true
        overwrite_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release Summary
      run: |
        echo "ðŸŽ‰ è‡ªåŠ¨æž„å»ºä¸Žå‘å¸ƒå®Œæˆï¼"
        echo "ðŸ“¦ å·²ç”Ÿæˆçš„åŒ…ï¼š"
        ls -lh dist/ || true
        echo "ðŸ·ï¸ å‘å¸ƒåç§°: Appwrite Functions"
        echo "ðŸ”— å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/appwrite-functions-latest"
