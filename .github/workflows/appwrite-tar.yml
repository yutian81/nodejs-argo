name: Build and Release Appwrite

on:
  push:
    branches: [ appwrite ]
    paths:
      - 'appwrite-au/**'
      - 'appwrite-de/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code (Appwrite 分支)
      uses: actions/checkout@v4
      with:
        ref: appwrite

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Validate required directories
      run: |
        for dir in appwrite-au appwrite-de; do
          if [ ! -d "$dir" ]; then
            echo "❌ 目录 $dir 不存在！"
            exit 1
          fi
          echo "✅ 找到目录: $dir"
        done

    - name: Display directory info
      run: |
        echo "📂 当前目录结构:"
        ls -la
        echo ""
        for dir in appwrite-au appwrite-de; do
          echo "📁 $dir 内容:"
          ls -la "$dir"
          echo ""
        done

    - name: Create deployment archives
      id: package
      run: |
        TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
        echo "当前UTC时间戳: $TIMESTAMP"
        mkdir -p dist
        for dir in appwrite-au appwrite-de; do
          ARCHIVE_NAME="${dir}.${TIMESTAMP}.tar.gz"
          tar -czf "dist/${ARCHIVE_NAME}" "$dir"
          echo "✅ 已创建压缩包: dist/${ARCHIVE_NAME}"
        done
        echo "archives=$(ls dist/*.tar.gz | tr '\n' ' ')" >> $GITHUB_OUTPUT

    - name: Verify archives
      run: |
        echo "📦 已生成压缩包列表:"
        ls -lh dist/
        for file in dist/*.tar.gz; do
          echo "🔍 $file 内容:"
          tar -tzf "$file"
          echo ""
        done

    - name: Generate release notes
      id: release_notes
      run: |
        LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        COMMIT_DATE=$(git log -1 --pretty=format:"%cd" --date=format:"%Y-%m-%d %H:%M")
        SHORT_SHA=$(git rev-parse --short HEAD)

        cat > release_notes.md << EOF
        ## 🚀 Appwrite Functions 部署包

        本次构建自动打包以下目录：
        - appwrite-au
        - appwrite-de

        **最近提交：**
        - 提交信息: ${LATEST_COMMIT}
        - 提交作者: ${COMMIT_AUTHOR}
        - 提交时间: ${COMMIT_DATE}
        - 提交版本: ${SHORT_SHA}

        📦 打包时间 (UTC): $(date -u +"%Y-%m-%d %H:%M:%S")

        上传以下压缩包以部署至 Appwrite：
        $(ls dist/*.tar.gz | xargs -n1 -I {} echo "- {}")
        EOF

    - name: Create or Update Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "appwrite-functions-latest"
        name: "Appwrite Functions"
        body_path: release_notes.md
        files: dist/*.tar.gz
        draft: false
        prerelease: false
        make_latest: true
        overwrite_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release Summary
      run: |
        echo "🎉 自动构建与发布完成！"
        echo "📦 包文件:"
        ls -lh dist/
        echo "🏷️ 发布名称: Appwrite Functions"
        echo "🔗 发布地址: https://github.com/${{ github.repository }}/releases/tag/appwrite-functions-latest"
