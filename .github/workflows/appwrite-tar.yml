name: Build and Release Appwrite

on:
  push:
    branches: [appwrite]
    paths:
      - 'appwrite-*'
      - 'appwrite-*/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (Appwrite åˆ†æ”¯)
        uses: actions/checkout@v4
        with:
          ref: appwrite

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate there are appwrite-* directories
        run: |
          set -euo pipefail
          shopt -s nullglob
          matches=(appwrite-*/)
          if [ ${#matches[@]} -eq 0 ]; then
            echo "âŒ æœªå‘ç°ä»»ä½•ä»¥ appwrite- å¼€å¤´çš„é¡¶å±‚ç›®å½•"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°ä»¥ä¸‹ç›®å½•ï¼š"
          for d in "${matches[@]}"; do
            echo " - ${d%/}"
          done

      - name: Display directory info
        run: |
          set -euo pipefail
          echo "ğŸ“‚ æ ¹ç›®å½•åˆ—è¡¨:"
          ls -la
          echo ""
          shopt -s nullglob
          for d in appwrite-*/; do
            dir="${d%/}"
            echo "ğŸ“ ${dir} å†…å®¹:"
            ls -la "$dir" || true
            echo ""
          done

      - name: Create deployment archives
        id: package
        run: |
          set -euo pipefail
          TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
          echo "å½“å‰UTCæ—¶é—´æˆ³: $TIMESTAMP"
          mkdir -p dist

          for dir in $(find . -maxdepth 1 -type d -name "appwrite-*"); do
            BASENAME=$(basename "$dir")
            ARCHIVE_NAME="${BASENAME}.${TIMESTAMP}.tar.gz"
            echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ… $dir â†’ dist/${ARCHIVE_NAME}"
            tar -czf "dist/${ARCHIVE_NAME}" -C "$dir" .
            echo "âœ… å·²åˆ›å»ºå‹ç¼©åŒ…: dist/${ARCHIVE_NAME}"
          done

          if ! ls dist/*.tar.gz >/dev/null 2>&1; then
            echo "âŒ æœªç”Ÿæˆä»»ä½•å‹ç¼©åŒ…ï¼ˆå¯èƒ½æ²¡æœ‰åŒ¹é…ç›®å½•ï¼‰"
            exit 1
          fi

          echo "archives=$(ls dist/*.tar.gz | tr '\n' ' ')" >> "$GITHUB_OUTPUT"

      - name: Verify archives
        run: |
          set -euo pipefail
          echo "ğŸ“¦ dist/ ç›®å½•å†…å®¹ï¼š"
          ls -lh dist/ || true
          for f in dist/*.tar.gz; do
            echo "ğŸ” æŸ¥çœ‹ $f å†…å®¹:"
            tar -tzf "$f" | head -n 20
            echo ""
          done

      - name: Generate release notes
        id: release_notes
        run: |
          set -euo pipefail
          LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          COMMIT_DATE=$(git log -1 --pretty=format:"%cd" --date=format:"%Y-%m-%d %H:%M")
          SHORT_SHA=$(git rev-parse --short HEAD)

          {
            echo "## ğŸš€ Appwrite Functions éƒ¨ç½²åŒ…"
            echo ""
            echo "æœ¬æ¬¡æ„å»ºè‡ªåŠ¨æ‰“åŒ…äº†ä»“åº“ä¸­æ‰€æœ‰ä»¥ **appwrite-** å¼€å¤´çš„ç›®å½•ã€‚"
            echo ""
            echo "**æœ€è¿‘æäº¤ï¼š**"
            echo "- æäº¤ä¿¡æ¯: ${LATEST_COMMIT}"
            echo "- æäº¤ä½œè€…: ${COMMIT_AUTHOR}"
            echo "- æäº¤æ—¶é—´: ${COMMIT_DATE}"
            echo "- æäº¤ç‰ˆæœ¬: ${SHORT_SHA}"
            echo ""
            echo "ğŸ“¦ æ‰“åŒ…æ—¶é—´ (UTC): $(date -u +"%Y-%m-%d %H:%M:%S")"
            echo ""
            echo "**ä¸Šä¼ çš„å‹ç¼©åŒ…ï¼š**"
            for f in dist/*.tar.gz; do
              echo "- ${f}"
            done
          } > release_notes.md

      - name: Delete old release (if exists)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "ğŸ§¹ æ£€æŸ¥æ—§çš„ release æ˜¯å¦å­˜åœ¨..."
          if gh release view "appwrite-functions-latest" >/dev/null 2>&1; then
            echo "âš ï¸ å‘ç°æ—§çš„ releaseï¼Œæ­£åœ¨åˆ é™¤..."
            gh release delete "appwrite-functions-latest" --yes
            echo "âœ… å·²åˆ é™¤æ—§çš„ releaseã€‚"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ—§çš„ releaseã€‚"
          fi

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "appwrite-functions-latest"
          name: "Appwrite Functions"
          body_path: release_notes.md
          files: dist/*.tar.gz
          draft: false
          prerelease: false
          make_latest: true
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "ğŸ‰ è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒå®Œæˆï¼"
          echo "ğŸ“¦ å·²ç”Ÿæˆçš„åŒ…ï¼š"
          ls -lh dist/ || true
          echo "ğŸ·ï¸ å‘å¸ƒåç§°: Appwrite Functions"
          echo "ğŸ”— å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/appwrite-functions-latest"
